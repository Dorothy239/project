<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Haven - Discover Your Next Read</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Philosopher:wght@400;700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* Previous CSS remains the same */
        :root {
            --primary-bg: #FFF5EE;
            --secondary-bg: hsl(203, 30%, 26%);
            --accent-color: #C29495;
            --accent-dark: #856088;
            --white: #FFFFFF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: seashell;
            color: hsl(203, 30%, 26%);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Navbar Styles */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color:  hsl(203, 30%, 26%);
            color: var(--white);
            padding: 15px 5%;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-logo {
            display: flex;
            align-items: center;
            font-family: 'Philosopher', serif;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--white);
            text-decoration: none;
        }

        .navbar-links {
            display: flex;
            gap: 20px;
        }

        .navbar-links a {
            color: var(--white);
            text-decoration: none;
            transition: color 0.3s ease;
            position: relative;
        }

        .navbar-links a::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -5px;
            left: 0;
            background-color: var(--accent-color);
            transition: width 0.3s ease;
        }

        .navbar-links a:hover::after {
            width: 100%;
        }

        .mobile-menu-icon {
            display: none;
            cursor: pointer;
            flex-direction: column;
            gap: 5px;
        }

        .mobile-menu-icon span {
            height: 3px;
            width: 25px;
            background-color: var(--white);
            transition: all 0.3s ease;
        }

        /* Main Content */
        .main-content {
            margin-top: 80px;
            padding: 20px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Results Grid Layout */
        .results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            justify-content: center;
            width: 100%;
            margin: 20px auto;
        }

        .book {
            background-color: var(--white);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 15px;
        }

        .book:hover {
            transform: scale(1.05);
        }

        .book img {
            width: 150px;
            height: 225px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .book h4 {
            font-size: 16px;
            color: hsl(203, 30%, 26%);
            margin-bottom: 5px;
            max-height: 3em;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .book p {
            font-size: 14px;
            color: hsl(203, 30%, 26%);
            margin-bottom: 5px;
            max-height: 4.5em;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Genre Filter Styles */
        .genre-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .genre-filter button {
            background-color: var(--accent-color);
            color: var(--white);
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .genre-filter button.active {
            background-color: var(--accent-dark);
        }

        /* Pagination Styles */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }

        .pagination button {
            background-color: var(--secondary-bg);
            color: var(--white);
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .pagination button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }

        .pagination .page-info {
            color: var(--secondary-bg);
            font-weight: bold;
        }

        /* Newsletter Styles */
        .newsletter {
            background-color: hsl(203, 30%, 26%);
            color: var(--white);
            padding: 30px;
            text-align: center;
            border-radius: 10px;
            margin-top: 30px;
        }

        .newsletter input {
            width: 100%;
            max-width: 400px;
            padding: 10px;
            margin: 15px 0;
            border: none;
            border-radius: 5px;
        }

        .newsletter button {
            background-color: gray;
            color: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Responsive Adjustments */
        @media screen and (max-width: 768px) {
            .navbar-links {
                position: fixed;
                top: 0;
                right: -300px;
                width: 250px;
                height: 100%;
                background-color: var(--secondary-bg);
                flex-direction: column;
                padding: 100px 20px;
                transition: right 0.3s ease;
                z-index: 999;
            }

            .navbar-links.active {
                right: 0;
            }

            .mobile-menu-icon {
                display: flex;
            }

            .results {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }

            .book {
                padding: 10px;
            }

            .book img {
                width: 120px;
                height: 180px;
            }
        }
        
        /* New styles for reviews */
        .book-details {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--white);
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 2000;
        }

        .book-details .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }

        .reviews-section {
            margin-top: 20px;
        }

        .review {
            background-color: var(--primary-bg);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .star-rating {
            color: #FFD700;
            font-size: 1.2rem;
        }

        .add-review-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1500;
            display: none;
        }

        footer {
            background-color: #37474F;
            color: white;
            text-align: center;
        }
        .isbn-scanner-container {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: var(--white);
    padding: 20px;
    border-radius: 10px;
    z-index: 2000;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    text-align: center;
}

/* Video container with visual indicator */
.video-container {
    position: relative;
    width: 100%;
    height: 300px;
    margin: 15px 0;
    border: 2px solid var(--accent-color);
    border-radius: 8px;
    overflow: hidden;
    background: #222;
}

/* Ensure video is visible and properly sized */
.isbn-scanner-container video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

/* Add scanning overlay guide */
.scanning-guide {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 70%;
    height: 100px;
    border: 2px dashed #fff;
    border-radius: 5px;
    box-shadow: 0 0 0 99999px rgba(0, 0, 0, 0.5);
    pointer-events: none;
}

.scanning-line {
    position: absolute;
    width: 100%;
    height: 2px;
    background-color: red;
    top: 50%;
    left: 0;
    animation: scan 2s linear infinite;
}

@keyframes scan {
    0% { top: 20%; }
    50% { top: 80%; }
    100% { top: 20%; }
}

.isbn-scanner-controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 15px;
}

.isbn-scanner-controls button {
    background-color: var(--accent-color);
    color: var(--white);
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    transition: background-color 0.3s ease;
}

.isbn-scanner-controls button:hover {
    background-color: var(--accent-dark);
}

#scanOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    z-index: 1999;
    display: none;
}

#scanResult {
    margin-top: 10px;
    font-weight: 500;
    min-height: 24px;
    color: var(--secondary-bg);
}

#scanIsbnBtn {
    background-color: var(--accent-dark);
    color: var(--white);
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}
    </style>
</head>
<body>
     <!-- Navbar -->
    <nav class="navbar">
        <a href="#" class="navbar-logo">
            ðŸ“– Book Haven
        </a>
        <div class="mobile-menu-icon" id="mobileMenuToggle">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="navbar-links" id="navbarLinks">
            <a href="book review.html">Home</a>
            <a href="book_list.html">Book Search</a>
            <a href="aboutus.html">About</a>
            <a href="#">icon</a> <!--login icon should be here-->
        </div>
    </nav>

    <div class="main-content">
        <div class="container">
            <h1>Book Discovery</h1>
            
            <!-- Genre Filter -->
            <div class="genre-filter" id="genreFilter">
                <button data-genre="all" class="active">All Genres</button>
                <!-- Genres will be dynamically populated -->
            </div>

            <form id="searchForm">
                <select id="queryType">
                    <option value="title">Title</option>
                    <option value="author">Author</option>
                    <option value="isbn">ISBN</option>
                </select>
                <input type="text" id="queryInput" placeholder="Enter your search term" required>
                <button id="searchButton" type="submit">Search</button>
                <!-- Add this button after the search button in the search form -->
<button id="scanIsbnBtn" type="button">Scan ISBN</button>
            </form>
            
            <div class="results" id="results"></div>
            
            <!-- Pagination -->
            <div class="pagination" id="pagination">
                <button id="prevPage" disabled>Previous</button>
                <span class="page-info" id="pageInfo">Page 1</span>
                <button id="nextPage" disabled>Next</button>
            </div>
        </div>

    </div>

    <footer>
        <section class="newsletter">
            <h2>Stay Updated with Book Haven</h2>
            <p>Subscribe to our newsletter for book recommendations and updates!</p>
            <form id="newsletterForm">
                <input type="email" id="newsletterEmail" placeholder="Enter your email" required>
                <button type="submit">Subscribe</button>
            </form>
        </section>
    </footer>

    <!-- Overlay for book details -->
    <div class="overlay" id="overlay"></div>
    <div class="book-details" id="bookDetails" style="display:none;">
        <!-- Book details and reviews will be dynamically populated here -->
    </div>
    
<div id="scanOverlay"></div>
<div class="isbn-scanner-container" id="isbnScannerContainer">
    <h2>ISBN Scanner</h2>
    <p>Position barcode in the highlighted area</p>
    
    <div class="video-container">
        <video id="videoFeed" playsinline autoplay></video>
        <div class="scanning-guide">
            <div class="scanning-line"></div>
        </div>
    </div>
    
    <div class="isbn-scanner-controls">
        <button id="startScanBtn">Start Camera</button>
        <button id="closeScanBtn">Close</button>
    </div>
    <p id="scanResult">Press Start Camera to begin</p>
</div>
    

    <script>
        // Existing code remains the same
        // Genre List (expanded from common literary genres)
        const GENRES = [
            'Fiction', 'Non-Fiction', 'Mystery', 'Science Fiction', 
            'Fantasy', 'Romance', 'Thriller', 'Historical Fiction', 
            'Biography', 'Poetry', 'Science', 'Self-Help'
        ];

        // Populate Genre Filters
        const genreFilter = document.getElementById('genreFilter');
        GENRES.forEach(genre => {
            const button = document.createElement('button');
            button.textContent = genre;
            button.dataset.genre = genre.toLowerCase().replace(' ', '-');
            button.addEventListener('click', () => {
                // Remove active class from all buttons
                genreFilter.querySelectorAll('button').forEach(btn => 
                    btn.classList.remove('active'));
                button.classList.add('active');
                
                // Filter results based on genre
                filterResultsByGenre(button.dataset.genre);
            });
            genreFilter.appendChild(button);
        });

        // Pagination and Search Variables
        let currentPage = 1;
        const RESULTS_PER_PAGE = 10;
        let totalBooks = [];
        let filteredBooks = [];

        // Enhanced Book Search Function
        function performBookSearch(queryType, queryValue) {
            let apiUrl;
            switch(queryType) {
                case 'title':
                    apiUrl = `https://openlibrary.org/search.json?title=${encodeURIComponent(queryValue)}`;
                    break;
                case 'author':
                    apiUrl = `https://openlibrary.org/search.json?q=author:${encodeURIComponent(queryValue)}`;
                    break;
                case 'isbn':
                    apiUrl = `https://openlibrary.org/search.json?isbn=${encodeURIComponent(queryValue)}`;
                    break;
                default:
                    apiUrl = `https://openlibrary.org/search.json?title=${encodeURIComponent(queryValue)}`;
            }

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    // Filter and enrich book data
                    totalBooks = data.docs
                        .filter(book => 
                            book.title && 
                            book.author_name && 
                            book.cover_i // Ensure we have a cover
                        )
                        .map(book => ({
                            ...book,
                            genre: determineGenre(book),
                            coverUrl: `https://covers.openlibrary.org/b/id/${book.cover_i}-M.jpg`
                        }));

                    filteredBooks = totalBooks;
                    displayResults();
                })
                .catch(error => {
                    console.error('Search error:', error);
                    document.getElementById("results").innerHTML = "<p>Error fetching book details.</p>";
                });
        }

        // Determine Genre Based on Book Metadata
        function determineGenre(book) {
            // Simple genre detection based on subject or keywords
            const subjectLower = (book.subject || []).map(s => s.toLowerCase());
            const genreMappings = {
                'mystery': ['detective', 'crime', 'mystery'],
                'science fiction': ['sci-fi', 'space', 'future', 'technology'],
                'fantasy': ['magic', 'dragon', 'fantasy', 'mythical'],
                'romance': ['love', 'relationship', 'romance'],
                'historical fiction': ['history', 'historical', 'period'],
                'thriller': ['suspense', 'tension', 'thriller'],
                'non-fiction': ['biography', 'history', 'science', 'philosophy']
            };

            for (const [genre, keywords] of Object.entries(genreMappings)) {
                if (keywords.some(keyword => 
                    subjectLower.some(subject => subject.includes(keyword))
                )) {
                    return genre;
                }
            }
            return 'fiction'; // Default genre
        }

        // Filter Results by Genre
        function filterResultsByGenre(genre) {
            if (genre === 'all') {
                filteredBooks = totalBooks;
            } else {
                filteredBooks = totalBooks.filter(book => 
                    book.genre.toLowerCase() === genre
                );
            }
            currentPage = 1;
            displayResults();
        }

        // Display Paginated Results
        function displayResults() {
            const resultsDiv = document.getElementById("results");
            const prevButton = document.getElementById("prevPage");
            const nextButton = document.getElementById("nextPage");
            const pageInfo = document.getElementById("pageInfo");

            // Calculate pagination
            const startIndex = (currentPage - 1) * RESULTS_PER_PAGE;
            const endIndex = startIndex + RESULTS_PER_PAGE;
            const paginatedBooks = filteredBooks.slice(startIndex, endIndex);

            // Clear previous results
            resultsDiv.innerHTML = "";

            // Display books
            if (paginatedBooks.length > 0) {
                paginatedBooks.forEach(book => {
                    const bookElement = document.createElement('div');
                    bookElement.classList.add('book');
                    bookElement.innerHTML = `
                        <img src="${book.coverUrl}" alt="${book.title}">
                        <div>
                            <h4>${book.title}</h4>
                            <p><strong>Author:</strong> ${book.author_name.join(', ')}</p>
                            <p><strong>Genre:</strong> ${book.genre}</p>
                            <p><strong>Year:</strong> ${book.first_publish_year || 'N/A'}</p>
                        </div>
                    `;
                    resultsDiv.appendChild(bookElement);
                });

                // Update pagination buttons
                prevButton.disabled = currentPage === 1;
                nextButton.disabled = endIndex >= filteredBooks.length;
                pageInfo.textContent = `Page ${currentPage} of ${Math.ceil(filteredBooks.length / RESULTS_PER_PAGE)}`;
            } else {
                resultsDiv.innerHTML = "<p>No books found.</p>";
                prevButton.disabled = true;
                nextButton.disabled = true;
                pageInfo.textContent = "Page 1 of 1";
            }
        }

        // Pagination Event Listeners
        document.getElementById("prevPage").addEventListener("click", () => {
            if (currentPage > 1) {
                currentPage--;
                displayResults();
            }
        });

        document.getElementById("nextPage").addEventListener("click", () => {
            if (currentPage < Math.ceil(filteredBooks.length / RESULTS_PER_PAGE)) {
                currentPage++;
                displayResults();
            }
        });

        // Search Form Submission
        document.getElementById("searchForm").addEventListener("submit", function(e) {
            e.preventDefault();
            const queryType = document.getElementById("queryType").value;
            const queryValue = document.getElementById("queryInput").value;
            
            currentPage = 1;
            performBookSearch(queryType, queryValue);
        });

        // Newsletter Validation
        document.getElementById("newsletterForm").addEventListener("submit", function(e) {
            e.preventDefault();
            const emailInput = document.getElementById("newsletterEmail");
            const emailError = document.getElementById("emailError");
            
            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (emailRegex.test(emailInput.value)) {
                alert("Thank you for subscribing!");
                emailInput.value = '';
                emailError.style.display = 'none';
            } else {
                emailError.style.display = 'block';
            }
        });
        // Mobile Menu Toggle
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const navbarLinks = document.getElementById('navbarLinks');

        mobileMenuToggle.addEventListener('click', () => {
            navbarLinks.classList.toggle('active');
        });

        
        // Reviews and Ratings API Simulation
        const reviewsDatabase = {
            // Sample initial reviews
            'default': [
                {
                    id: 1,
                    username: 'BookLover123',
                    rating: 4.5,
                    text: 'Absolutely fantastic read! Couldn\'t put it down.',
                    date: '2024-03-15'
                },
                {
                    id: 2,
                    username: 'LiteraryNerd',
                    rating: 4.0,
                    text: 'Engaging storyline with well-developed characters.',
                    date: '2024-03-10'
                }
            ]
        };

        // Review Management Functions
        function getReviewsForBook(bookKey) {
            // If no specific reviews exist, return default reviews
            return reviewsDatabase[bookKey] || reviewsDatabase['default'];
        }

        function addReview(bookKey, review) {
            // Initialize book reviews array if not exists
            if (!reviewsDatabase[bookKey]) {
                reviewsDatabase[bookKey] = [];
            }

            // Add new review with unique ID
            review.id = Date.now();
            review.date = new Date().toISOString().split('T')[0];
            reviewsDatabase[bookKey].push(review);

            return review;
        }

        function calculateAverageRating(reviews) {
            if (reviews.length === 0) return 0;
            const totalRating = reviews.reduce((sum, review) => sum + review.rating, 0);
            return (totalRating / reviews.length).toFixed(1);
        }

        function renderStarRating(rating) {
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5 ? 1 : 0;
            const emptyStars = 5 - fullStars - halfStar;

            return 'â˜…'.repeat(fullStars) + 
                   (halfStar ? 'Â½' : '') + 
                   'â˜†'.repeat(emptyStars);
        }

        // Extend book display to show details and reviews
        function showBookDetails(book) {
            const bookDetails = document.getElementById('bookDetails');
            const overlay = document.getElementById('overlay');
            
            // Get reviews for this specific book
            const bookKey = book.key || 'default';
            const reviews = getReviewsForBook(bookKey);
            const averageRating = calculateAverageRating(reviews);

            bookDetails.innerHTML = `
                <button class="close-btn" onclick="closeBookDetails()">&times;</button>
                <div class="book-info">
                    <img src="${book.coverUrl}" alt="${book.title}" style="max-width: 200px; margin-bottom: 15px;">
                    <h2>${book.title}</h2>
                    <p><strong>Author:</strong> ${book.author_name.join(', ')}</p>
                    <p><strong>Genre:</strong> ${book.genre}</p>
                    <p><strong>Published:</strong> ${book.first_publish_year || 'N/A'}</p>
                    
                    <div class="book-rating">
                        <h3>Overall Rating: ${renderStarRating(averageRating)} (${averageRating})</h3>
                    </div>

                    <div class="reviews-section">
                        <h3>Reviews (${reviews.length})</h3>
                        ${reviews.map(review => `
                            <div class="review">
                                <div class="star-rating">${renderStarRating(review.rating)}</div>
                                <p><strong>${review.username}</strong> - ${review.date}</p>
                                <p>${review.text}</p>
                            </div>
                        `).join('')}
                    </div>

                    <form class="add-review-form" id="addReviewForm">
                        <h3>Add Your Review</h3>
                        <input type="text" placeholder="Your Username" required id="reviewUsername">
                        <select id="reviewRating" required>
                            <option value="">Select Rating</option>
                            <option value="5">5 Stars</option>
                            <option value="4">4 Stars</option>
                            <option value="3">3 Stars</option>
                            <option value="2">2 Stars</option>
                            <option value="1">1 Star</option>
                        </select>
                        <textarea placeholder="Your Review" required id="reviewText"></textarea>
                        <button type="submit">Submit Review</button>
                    </form>
                </div>
            `;

            // Add event listener for review submission
            const reviewForm = document.getElementById('addReviewForm');
            reviewForm.onsubmit = (e) => {
                e.preventDefault();
                const newReview = {
                    username: document.getElementById('reviewUsername').value,
                    rating: parseFloat(document.getElementById('reviewRating').value),
                    text: document.getElementById('reviewText').value
                };

                addReview(bookKey, newReview);
                showBookDetails(book); // Refresh the view
            };

            bookDetails.style.display = 'block';
            overlay.style.display = 'block';
        }

        function closeBookDetails() {
            document.getElementById('bookDetails').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        // Modify book display to add click event for details
        function displayResults() {
            const resultsDiv = document.getElementById("results");
            const prevButton = document.getElementById("prevPage");
            const nextButton = document.getElementById("nextPage");
            const pageInfo = document.getElementById("pageInfo");

            // Calculate pagination
            const startIndex = (currentPage - 1) * RESULTS_PER_PAGE;
            const endIndex = startIndex + RESULTS_PER_PAGE;
            const paginatedBooks = filteredBooks.slice(startIndex, endIndex);

            // Clear previous results
            resultsDiv.innerHTML = "";

            // Display books
            if (paginatedBooks.length > 0) {
                paginatedBooks.forEach(book => {
                    const bookElement = document.createElement('div');
                    bookElement.classList.add('book');
                    bookElement.innerHTML = `
                        <img src="${book.coverUrl}" alt="${book.title}">
                        <div>
                            <h4>${book.title}</h4>
                            <p><strong>Author:</strong> ${book.author_name.join(', ')}</p>
                            <p><strong>Genre:</strong> ${book.genre}</p>
                            <p><strong>Year:</strong> ${book.first_publish_year || 'N/A'}</p>
                        </div>
                    `;
                    
                    // Add click event to show book details
                    bookElement.addEventListener('click', () => showBookDetails(book));
                    
                    resultsDiv.appendChild(bookElement);
                });

                // Update pagination buttons
                prevButton.disabled = currentPage === 1;
                nextButton.disabled = endIndex >= filteredBooks.length;
                pageInfo.textContent = `Page ${currentPage} of ${Math.ceil(filteredBooks.length / RESULTS_PER_PAGE)}`;
            } else {
                resultsDiv.innerHTML = "<p>No books found.</p>";
                prevButton.disabled = true;
                nextButton.disabled = true;
                pageInfo.textContent = "Page 1 of 1";
            }
        }

        // Add event listener to close overlay when clicking outside
        document.getElementById('overlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                closeBookDetails();
            }
        });

        // Initialize Quagga Scanner with proper video display
function initializeScanner() {
    const videoFeed = document.getElementById('videoFeed');
    const scanResult = document.getElementById('scanResult');
    scanResult.textContent = 'Accessing camera...';
    
    // First make sure any previous instance is stopped
    if (typeof Quagga !== 'undefined' && Quagga.initialized) {
        Quagga.stop();
    }
    
    // Make sure video element is visible before initializing
    videoFeed.style.display = 'block';
    videoFeed.style.height = '300px';
    
    // Request direct camera access first to ensure we can see the feed
    navigator.mediaDevices.getUserMedia({ 
        video: { 
            facingMode: "environment",
            width: { ideal: 640 },
            height: { ideal: 480 }
        } 
    })
    .then(function(stream) {
        // Attach the stream directly to show it's working
        videoFeed.srcObject = stream;
        videoFeed.onloadedmetadata = function(e) {
            videoFeed.play();
            scanResult.textContent = "Camera active! You should see the video feed now.";
            
           
        };
    })
    .catch(function(err) {
        console.error("Error accessing camera:", err);
        scanResult.textContent = "Camera access error: " + err.message;
    });
    
    // Function to initialize Quagga after confirming camera works
    function initializeQuagga() {
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: videoFeed,
                constraints: {
                    width: 1280,
                    height: 720,
                    facingMode: "environment" // Use back camera if available
                },
                area: { // Define scan area
                    top: "30%",    
                    right: "30%",  
                    left: "30%",   
                    bottom: "30%"  
                },
            },
            locator: {
                patchSize: "medium",
                halfSample: true
            },
            frequency: 10,
            decoder: {
                readers: [
                    "ean_reader", 
                    "ean_8_reader",
                    "code_128_reader", // Adding more readers for better detection
                    "code_39_reader",
                    "upc_reader",
                    "isbn_reader"  // Ensures ISBN detection specifically
                ]
            },
            locate: true
        }, function(err) {
            if (err) {
                console.error("Quagga initialization error:", err);
                scanResult.textContent = "Scanner error: " + err.message;
                return;
            }
            
            scanResult.textContent = "Scanner active. Point at barcode.";
            console.log("Quagga initialized successfully");
            Quagga.start();
        });

        // Handle successful barcode detection
        Quagga.onDetected(function(result) {
            const isbn = result.codeResult.code;
            scanResult.textContent = "Found: " + isbn;
            console.log("Detected code:", isbn);
            
            // Play a success sound
            const beep = new Audio('data:audio/wav;base64,//uQRAAAAWMSLwUIYAAsYkXgoQwAEaYLWfkWgAI0wWs/ItAAAGDgYtAgAyN+QWaAAihwMWm4G8QQRDiMcCBcH3Cc+CDv/7xA4Tvh9Rz/y8QADBwMWgQAZG/ILNAARQ4GLTcDeIIIhxGOBAuD7hOfBB3/94gcJ3w+o5/5eIAIAAAVwWgQAVQ2ORaIQwEMAJiDg95G4nQL7mQVWI6GwRcfsZAcsKkJvxgxEjzFUgfHoSQ9Qq7KNwqHwuB13MA4a1q/DmBrHgPcmjiGoh//EwC5nGPEmS4RcfkVKOhJf+WOgoxJclFz3kgn//dBA+ya1GhurNn8zb//9NNutNuhz31f////9vt///z+IdAEAAAK4LQIAKobHItEIYCGAExBwe8jcToF9zIKrEdDYIuP2MgOWFSE34wYiR5iqQPj0JIeoVdlG4VD4XA67mAcNa1fhzA1jwHuTRxDUQ//iYBczjHiTJcIuPyKlHQkv/LHQUYkuSi57yQT//uggfZNajQ3Vm///ezyNwACAACuBlEAVKoBLzBi8HYwkCbdp77+0SCi/uVlMnYZcH3PXvHyQHYF8K5QYlKfayPsBKSML0OiVYyY0AAAAbSURBVHicY/jPwMBQD8T//v0DiJ8AYKcMAOl+SkMAAAAASUVORK5CYII=');
            beep.play();
            
            // Add a short delay before closing to show the result
            setTimeout(() => {
                // Stop scanner and perform book search
                document.getElementById('queryType').value = 'isbn';
                document.getElementById('queryInput').value = isbn;
                setTimeout(() => Quagga.stop(), 500)
                
                // Trigger the search
                document.getElementById('searchButton').click();
                
                // Close scanner
                closeScanner();
            }, 1000);
        });
        
        // Draw scanning area
        Quagga.onProcessed(function(result) {
            var drawingCtx = Quagga.canvas.ctx.overlay,
                drawingCanvas = Quagga.canvas.dom.overlay;

            if (result) {
                if (result.boxes) {
                    drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                    result.boxes.filter(function (box) {
                        return box !== result.box;
                    }).forEach(function (box) {
                        Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                    });
                }

                if (result.box) {
                    Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "blue", lineWidth: 2});
                }

                if (result.codeResult && result.codeResult.code) {
                    Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
                }
            }
        });
    }
}
// Get scanner-related elements
const scannerContainer = document.getElementById('isbnScannerContainer');
const scanOverlay = document.getElementById('scanOverlay');
const startScanBtn = document.getElementById('startScanBtn');
const closeScanBtn = document.getElementById('closeScanBtn');
const scanIsbnBtn = document.getElementById('scanIsbnBtn');

// Open scanner when scan button is clicked
scanIsbnBtn.addEventListener('click', function() {
    scannerContainer.style.display = 'block';
    scanOverlay.style.display = 'block';
});

// Start camera when start button is clicked
startScanBtn.addEventListener('click', function() {
    initializeScanner();
});

// Close scanner when close button is clicked
closeScanBtn.addEventListener('click', function() {
    closeScanner();
});

// Function to close scanner
function closeScanner() {
    // Stop Quagga if it's running
    if (typeof Quagga !== 'undefined' && Quagga.initialized) {
        Quagga.stop();
    }
    
    // Close the video stream if it exists
    const videoFeed = document.getElementById('videoFeed');
    if (videoFeed.srcObject) {
        videoFeed.srcObject.getTracks().forEach(track => track.stop());
        videoFeed.srcObject = null;
    }
    
    // Hide the scanner UI
    scannerContainer.style.display = 'none';
    scanOverlay.style.display = 'none';
    
    // Reset result text
    document.getElementById('scanResult').textContent = 'Press Start Camera to begin';
}
    </script>
</body>
</html>
